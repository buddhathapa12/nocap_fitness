<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Wellbeing Agent</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .expand-button {
            transition: transform 0.3s ease;
        }
        .expanded .expand-button {
            transform: rotate(90deg);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <!-- Sidebar content replicated at the top for simplicity in a single-page app -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">OpenAI API Key</h2>
            <input type="password" id="api-key" placeholder="Enter your OpenAI API Key"
                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md">
                <h3 class="font-bold text-lg mb-2">‚ö†Ô∏è Important Notice</h3>
                <p class="text-sm">
                    This application is a supportive tool and does not replace professional mental health care. If you're experiencing thoughts of self-harm or severe crisis:
                </p>
                <ul class="list-disc list-inside mt-2 text-sm">
                    <li>Call National Crisis Hotline: 988</li>
                    <li>Call Emergency Services: 911</li>
                    <li>Seek immediate professional help</li>
                </ul>
            </div>
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-900 mb-6">üß† Mental Wellbeing Agent</h1>

        <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-md mb-6">
            <h2 class="font-bold text-lg mb-2">Meet Your Mental Wellbeing Agent Team:</h2>
            <ul class="list-disc list-inside text-sm">
                <li>üß† <strong class="font-semibold">Assessment Agent</strong> - Analyzes your situation and emotional needs</li>
                <li>üéØ <strong class="font-semibold">Action Agent</strong> - Creates immediate action plan and connects you with resources</li>
                <li>üîÑ <strong class="font-semibold">Follow-up Agent</strong> - Designs your long-term support strategy</li>
            </ul>
        </div>

        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Personal Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="mental-state" class="block text-sm font-medium text-gray-700 mb-1">How have you been feeling recently?</label>
                <textarea id="mental-state" rows="4" placeholder="Describe your emotional state, thoughts, or concerns..."
                          class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label for="stress-level" class="block text-sm font-medium text-gray-700 mb-1">Current Stress Level (1-10)</label>
                <input type="range" id="stress-level" min="1" max="10" value="5"
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg accent-indigo-600">
                <span id="stress-level-value" class="block text-right text-sm text-gray-600 mt-1">5</span>
            </div>
            <div>
                <label for="sleep-pattern" class="block text-sm font-medium text-gray-700 mb-1">Sleep Pattern (hours per night)</label>
                <select id="sleep-pattern"
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <!-- Options will be dynamically generated by JS -->
                </select>
            </div>
            <div>
                <label for="support-system" class="block text-sm font-medium text-gray-700 mb-1">Current Support System</label>
                <select id="support-system" multiple
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 h-32">
                    <option value="Family">Family</option>
                    <option value="Friends">Friends</option>
                    <option value="Therapist">Therapist</option>
                    <option value="Support Groups">Support Groups</option>
                    <option value="None">None</option>
                </select>
            </div>
        </div>

        <div class="mb-6">
            <label for="recent-changes" class="block text-sm font-medium text-gray-700 mb-1">Any significant life changes or events recently?</label>
            <textarea id="recent-changes" rows="3" placeholder="Job changes, relationships, losses, etc..."
                      class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>

        <div class="mb-6">
            <label for="current-symptoms" class="block text-sm font-medium text-gray-700 mb-1">Current Symptoms</label>
            <select id="current-symptoms" multiple
                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 h-40">
                <option value="Anxiety">Anxiety</option>
                <option value="Depression">Depression</option>
                <option value="Insomnia">Insomnia</option>
                <option value="Fatigue">Fatigue</option>
                <option value="Loss of Interest">Loss of Interest</option>
                <option value="Difficulty Concentrating">Difficulty Concentrating</option>
                <option value="Changes in Appetite">Changes in Appetite</option>
                <option value="Social Withdrawal">Social Withdrawal</option>
                <option value="Mood Swings">Mood Swings</option>
                <option value="Physical Discomfort">Physical Discomfort</option>
            </select>
        </div>

        <button id="get-support-btn"
                class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out flex items-center justify-center">
            <span id="button-text">Get Support Plan</span>
            <div id="loading-spinner" class="spinner ml-3 hidden"></div>
        </button>

        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mt-4 hidden" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-md relative mt-4 hidden" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline">Mental health support plan generated successfully!</span>
        </div>

        <div class="mt-8 space-y-4">
            <div id="assessment-expander" class="bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <button class="w-full flex items-center justify-between p-4 font-semibold text-lg text-gray-800 focus:outline-none" onclick="toggleExpander('assessment-content', this)">
                    Situation Assessment
                    <svg class="w-5 h-5 text-gray-500 expand-button" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <div id="assessment-content" class="px-4 pb-4 text-gray-700 hidden">
                    <p>Content will appear here...</p>
                </div>
            </div>

            <div id="action-expander" class="bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <button class="w-full flex items-center justify-between p-4 font-semibold text-lg text-gray-800 focus:outline-none" onclick="toggleExpander('action-content', this)">
                    Action Plan & Resources
                    <svg class="w-5 h-5 text-gray-500 expand-button" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <div id="action-content" class="px-4 pb-4 text-gray-700 hidden">
                    <p>Content will appear here...</p>
                </div>
            </div>

            <div id="followup-expander" class="bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                <button class="w-full flex items-center justify-between p-4 font-semibold text-lg text-gray-800 focus:outline-none" onclick="toggleExpander('followup-content', this)">
                    Long-term Support Strategy
                    <svg class="w-5 h-5 text-gray-500 expand-button" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <div id="followup-content" class="px-4 pb-4 text-gray-700 hidden">
                    <p>Content will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Populate sleep pattern options
        const sleepPatternSelect = document.getElementById('sleep-pattern');
        for (let i = 0; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i} hours`;
            if (i === 7) {
                option.selected = true;
            }
            sleepPatternSelect.appendChild(option);
        }

        // Update stress level value display
        const stressLevelInput = document.getElementById('stress-level');
        const stressLevelValueSpan = document.getElementById('stress-level-value');
        stressLevelInput.addEventListener('input', () => {
            stressLevelValueSpan.textContent = stressLevelInput.value;
        });

        // Expander toggle function
        function toggleExpander(contentId, button) {
            const content = document.getElementById(contentId);
            const parent = button.closest('div');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                parent.classList.add('expanded');
            } else {
                content.classList.add('hidden');
                parent.classList.remove('expanded');
            }
        }

        const getSupportBtn = document.getElementById('get-support-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const successMessageDiv = document.getElementById('success-message');

        const assessmentContent = document.getElementById('assessment-content');
        const actionContent = document.getElementById('action-content');
        const followupContent = document.getElementById('followup-content');

        const systemMessages = {
            "assessment_agent": `
                You are an experienced mental health professional speaking directly to the user. Your task is to:
                1. Create a safe space by acknowledging their courage in seeking support
                2. Analyze their emotional state with clinical precision and genuine empathy
                3. Ask targeted follow-up questions to understand their full situation
                4. Identify patterns in their thoughts, behaviors, and relationships
                5. Assess risk levels with validated screening approaches
                6. Help them understand their current mental health in accessible language
                7. Validate their experiences without minimizing or catastrophizing

                Always use "you" and "your" when addressing the user. Blend clinical expertise with genuine warmth and never rush to conclusions.
                Start your response with: '## Situation Assessment'.
            `,
            "action_agent": `
                You are a crisis intervention and resource specialist speaking directly to the user. Your task is to:
                1. Provide immediate evidence-based coping strategies tailored to their specific situation
                2. Prioritize interventions based on urgency and effectiveness
                3. Connect them with appropriate mental health services while acknowledging barriers (cost, access, stigma)
                4. Create a concrete daily wellness plan with specific times and activities
                5. Suggest specific support communities with details on how to join
                6. Balance crisis resources with empowerment techniques
                7. Teach simple self-regulation techniques they can use immediately

                Focus on practical, achievable steps that respect their current capacity and energy levels. Provide options ranging from minimal effort to more involved actions.
                Start your response with: '## Action Plan & Resources'.
            `,
            "followup_agent": `
                You are a mental health recovery planner speaking directly to the user. Your task is to:
                1. Design a personalized long-term support strategy with milestone markers
                2. Create a progress monitoring system that matches their preferences and habits
                3. Develop specific relapse prevention strategies based on their unique triggers
                4. Establish a support network mapping exercise to identify existing resources
                5. Build a graduated self-care routine that evolves with their recovery
                6. Plan for setbacks with self-compassion techniques
                7. Set up a maintenance schedule with clear check-in mechanisms

                Focus on building sustainable habits that integrate with their lifestyle and values. Emphasize progress over perfection and teach skills for self-directed care.
                Start your response with: '## Long-term Support Strategy'.
            `
        };

        /**
         * Calls the Gemini API to generate content based on the prompt and system message.
         * @param {string} prompt The user's input or context for the model.
         * @param {string} systemMessage The persona/instructions for the model.
         * @param {string} apiKey The API key for authentication.
         * @returns {Promise<string>} The generated text from the model.
         */
        async function callGeminiAPI(prompt, systemMessage, apiKey) {
            let chatHistory = [];
            // Add the system message as a user part to guide the model's persona
            chatHistory.push({ role: "user", parts: [{ text: systemMessage }] });
            // Add the actual prompt for the model to respond to
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Unexpected API response structure or no content generated.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error; // Re-throw to be caught by the main function
            }
        }

        getSupportBtn.addEventListener('click', async () => {
            let apiKey = document.getElementById('api-key').value;
            // If the user hasn't provided an API key, ensure it's an empty string
            // so the environment can inject the default key for gemini-2.0-flash.
            if (!apiKey) {
                apiKey = "";
            }

            // Hide previous messages
            errorMessageDiv.classList.add('hidden');
            successMessageDiv.classList.add('hidden');
            assessmentContent.innerHTML = '<p>Content will appear here...</p>';
            actionContent.innerHTML = '<p>Content will appear here...</p>';
            followupContent.innerHTML = '<p>Content will appear here...</p>';

            // Show loading state
            getSupportBtn.disabled = true;
            buttonText.textContent = 'AI Agents are analyzing...';
            loadingSpinner.classList.remove('hidden');

            const mentalState = document.getElementById('mental-state').value;
            const sleepPattern = document.getElementById('sleep-pattern').value;
            const stressLevel = document.getElementById('stress-level').value;
            const supportSystem = Array.from(document.getElementById('support-system').selectedOptions).map(option => option.value);
            const recentChanges = document.getElementById('recent-changes').value;
            const currentSymptoms = Array.from(document.getElementById('current-symptoms').selectedOptions).map(option => option.value);

            const baseTask = `
                Create a comprehensive mental health support plan based on the following information:

                Emotional State: ${mentalState || 'Not provided'}
                Sleep: ${sleepPattern} hours per night
                Stress Level: ${stressLevel}/10
                Support System: ${supportSystem.length ? supportSystem.join(', ') : 'None reported'}
                Recent Changes: ${recentChanges || 'None reported'}
                Current Symptoms: ${currentSymptoms.length ? currentSymptoms.join(', ') : 'None reported'}
            `;

            let assessmentResult = '';
            let actionResult = '';
            let followupResult = '';

            try {
                // 1. Assessment Agent
                const assessmentPrompt = `
                    ${baseTask}

                    Your task is to provide a detailed situation assessment. Focus on understanding the user's current mental health state, identifying patterns, and validating their experiences.
                `;
                console.log("Calling Gemini API for Assessment with API Key:", apiKey ? "Provided" : "Default (empty string)");
                assessmentResult = await callGeminiAPI(assessmentPrompt, systemMessages.assessment_agent, apiKey);
                assessmentContent.innerHTML = assessmentResult;
                console.log("Assessment Result:", assessmentResult);

                // 2. Action Agent
                const actionPrompt = `
                    ${baseTask}

                    Based on the following assessment:
                    ${assessmentResult}

                    Your task is to create a concrete action plan with immediate coping strategies, relevant resources, daily wellness activities, and support community suggestions.
                `;
                console.log("Calling Gemini API for Action with API Key:", apiKey ? "Provided" : "Default (empty string)");
                actionResult = await callGeminiAPI(actionPrompt, systemMessages.action_agent, apiKey);
                actionContent.innerHTML = actionResult;
                console.log("Action Result:", actionResult);

                // 3. Follow-up Agent
                const followupPrompt = `
                    ${baseTask}

                    Based on the following assessment and action plan:
                    Assessment:
                    ${assessmentResult}

                    Action Plan:
                    ${actionResult}

                    Your task is to design a personalized long-term support strategy, including progress monitoring, relapse prevention, support network mapping, and a maintenance schedule.
                `;
                console.log("Calling Gemini API for Follow-up with API Key:", apiKey ? "Provided" : "Default (empty string)");
                followupResult = await callGeminiAPI(followupPrompt, systemMessages.followup_agent, apiKey);
                followupContent.innerHTML = followupResult;
                console.log("Follow-up Result:", followupResult);

                successMessageDiv.classList.remove('hidden');

            } catch (e) {
                errorMessageDiv.classList.remove('hidden');
                errorTextSpan.textContent = `An error occurred: ${e.message}`;
                console.error("Full error:", e);
            } finally {
                // Reset loading state
                getSupportBtn.disabled = false;
                buttonText.textContent = 'Get Support Plan';
                loadingSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
